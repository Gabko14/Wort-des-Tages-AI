name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write

jobs:
  supabase-dev:
    name: Deploy Supabase (Dev)
    runs-on: ubuntu-latest
    # Only run on PRs or non-main branches, and only if supabase files changed
    if: github.ref != 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for Supabase changes
        id: changes
        run: |
          if git diff --name-only origin/main...HEAD | grep -qE '^supabase/(migrations|functions)/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Supabase CLI
        if: steps.changes.outputs.changed == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Dev Project
        if: steps.changes.outputs.changed == 'true'
        run: supabase link --project-ref dclszvpstwnkzqfjvxwa
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Push Database Migrations
        if: steps.changes.outputs.changed == 'true'
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy Edge Functions
        if: steps.changes.outputs.changed == 'true'
        run: supabase functions deploy
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Skip notice
        if: steps.changes.outputs.changed == 'false'
        run: echo "No changes in supabase/migrations/ or supabase/functions/ - skipping deployment"

  validate:
    name: Validate (Lint, Test, Type Check)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm config set fetch-retry-maxtimeout 600000
          npm config set fetch-retry-mintimeout 10000
          npm ci --verbose

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npm run type-check

      - name: Run Tests with Coverage
        run: npm test -- --coverage --coverageReporters=json-summary

      - name: Build Web
        run: npx expo export --platform web

      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          set -euo pipefail

          # Extract coverage percentage from json-summary
          COVERAGE=$(node -e "
            const report = require('./coverage/coverage-summary.json');
            const pct = report.total.lines.pct;
            console.log(Math.round(pct));
          ")

          # Determine badge color based on coverage
          if [ "$COVERAGE" -ge 80 ]; then
            COLOR="brightgreen"
          elif [ "$COVERAGE" -ge 60 ]; then
            COLOR="yellow"
          elif [ "$COVERAGE" -ge 40 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi

          # Create badge JSON
          mkdir -p badges
          cat > badges/coverage.json <<EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${COVERAGE}%",
            "color": "${COLOR}"
          }
          EOF

          echo "Coverage: ${COVERAGE}% (color: ${COLOR})"

      - name: Commit coverage badge to badges branch
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          set -euo pipefail

          # Save the generated badge content
          BADGE_CONTENT=$(cat badges/coverage.json)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Clean up the local badges dir first to avoid checkout conflicts
          rm -rf badges

          # Try to fetch the badges branch, or create an orphan branch if it doesn't exist
          if git fetch origin badges:badges 2>/dev/null; then
            git checkout badges --
          else
            echo "Creating new orphan branch 'badges'"
            git checkout --orphan badges
            git rm -rf . || true
          fi

          # Restore the badge file
          mkdir -p badges
          echo "$BADGE_CONTENT" > badges/coverage.json

          git add badges/coverage.json

          # Check if there are actual changes
          if git diff --cached --quiet; then
            echo "No changes to coverage badge."
            exit 0
          fi

          git commit -m "chore: update coverage badge"
          git push origin badges
